---
sidebar_position: 1
---

## **题目：**
1、PC1 web 连接 server2，给 server2 安装 rocky-arm64 CLI 系统（语 
言为英文）。 
2、配置 server2 的 IPv4 地址为 10.4.220.100/24。 
3、安装 qemu-kvm、libvirt 和 virt-install。 
4、创建 rocky-arm64 虚拟机，虚拟机磁盘文件保存在默认目录，名称为 
linuxN.qcow2(N 表示虚拟机编号 0-9，如虚拟机 linux1 的磁盘文件 
为 linux1.qcow2),虚拟机信息如下： 
![image.png](https://cdn.nlark.com/yuque/0/2023/png/33622884/1694490920405-371f8edd-6f7b-4a4a-a799-eb9d105cad81.png#averageHue=%23ebeae8&clientId=udd1cf54e-ae3b-4&from=paste&height=396&id=ub259c120&originHeight=544&originWidth=947&originalType=binary&ratio=1.375&rotation=0&showTitle=false&size=85202&status=done&style=none&taskId=u04765d5a-1eeb-47bb-9f96-350bec68a20&title=&width=688.7272727272727)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/33622884/1694490934456-df3891ea-c2f5-4196-b85a-7ae782818d28.png#averageHue=%23eae9e7&clientId=udd1cf54e-ae3b-4&from=paste&height=90&id=uce965b34&originHeight=124&originWidth=946&originalType=binary&ratio=1.375&rotation=0&showTitle=false&size=17370&status=done&style=none&taskId=u1ed8c0a8-430c-437c-8e1f-7de73b2065f&title=&width=688)
4.1 安装 linux0，系统为 rocky9 CLI，网络模式为桥接模式，用户 root 
密码为 Key-1122。 
4.2 关闭 linux0，给 linux0 创建快照，快照名称为 linux-snapshot。 
根据 linux0 克隆虚拟机 linux1-linux9。
## 配置步骤：
## 1小题
1.1 修改Ubuntu IP地址与鲲泰服务器管理口同网段
1.2 web登录管理后台鲲泰服务器管理口为192.168.2.10
用户名：Admin 密码：Admin@123
1.3 创建逻辑盘（非必须）服务器可能存在两块较小的磁盘，例如一块只有480G，需要进行合并成逻辑盘，不然可能不够完成9台甚至更多的虚拟机安装
1.4  启动虚拟控制台位于首页右下角---选择html5共享模式
1.5 连接安装镜像点击光盘图标--连接位于本地的镜像文件
1.6 选择光驱启动选择B图标--选择光驱
1.7 强制重启鲲泰点击电源图标--选择强制重启
1.8 选择安装rocky需要关注安装界面的变化，跳出提示就快速选择安装rocky，不然它自动选择检查再安装会浪费很多时间
1.9 进行磁盘分区注意：题目中有明确要求分区容量就按题目来配置，没有要求的话boot分区1G即可，swap分区10G即可，home分区20G即可，其余空间都给/根分区，
1.10 选择安装版本选择最小化安装版本
1.11 配置密码按题目要求配置
1.12 进行安装所有设置完成后，进行安装。
## 2小题
2.1 创建桥接网卡nmcli c add type bridge ifname br0 #创建桥设备 br0
nmcli c add type bridge-slave ifname enp125s0f0 master br0 #配置桥设备桥接的网卡
2.2 修改本地网卡为自动获取vi /etc/NetworkManager/system-connections/enp125s0f0.nmconnection
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710911651823-e9cded61-2456-4463-8706-59b2cc40d5f1.png#averageHue=%23121212&clientId=u5933070e-09df-4&from=paste&height=407&id=ag8yd&originHeight=488&originWidth=887&originalType=binary&ratio=1.2000000476837158&rotation=0&showTitle=false&size=28140&status=done&style=none&taskId=uddc324c7-378f-4824-9aa3-a94367263c0&title=&width=739.1666372948234)
2.3 修改桥设备的IP地址为静态vi /etc/NetworkManager/system-connections/bridge-br0.nmconnection
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710911680754-6ba08193-cc69-4490-811b-f27c5666d7ac.png#averageHue=%23131313&clientId=u5933070e-09df-4&from=paste&height=449&id=T6vjC&originHeight=539&originWidth=807&originalType=binary&ratio=1.2000000476837158&rotation=0&showTitle=false&size=29307&status=done&style=none&taskId=u75cc8421-68ce-45fb-9323-33072d5aca0&title=&width=672.499973277252)
2.4 重启网卡nmcli connection reload + 桥接网卡配置文件路径  #加载配置信息，立即生效
nmcli connection up + 桥接网卡配置文件路径         #激活配置
nmcli 查看网络连接情况![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710911811038-559f019e-c9a0-478b-a258-5a0b5faf16dd.png#averageHue=%23141414&clientId=u5933070e-09df-4&from=paste&height=814&id=y1d2w&originHeight=977&originWidth=879&originalType=binary&ratio=1.2000000476837158&rotation=0&showTitle=false&size=98767&status=done&style=none&taskId=u42f324f8-378e-4dac-abb9-0aeee5a34cf&title=&width=732.4999708930663)
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1713178227265-2521bcf3-3d3d-4943-bdd7-6087ed65a5e3.png#averageHue=%230a0a0a&clientId=uc98eb0ec-f630-4&from=paste&height=153&id=ud5c19272&originHeight=143&originWidth=958&originalType=binary&ratio=0.9375&rotation=0&showTitle=false&size=46979&status=done&style=none&taskId=ue4b8403f-2b9c-4e51-a443-13c885bc3f0&title=&width=1021.8666666666667)
## 3小题
3.1 Ubuntu传输镜像到Server2scp + 镜像名 + root@10.4.220.100:/opt  #在Ubuntu传输镜像到Server2的opt目录下
3.2 搭建本地yum源Server2执行以下操作
mount /opt/镜像名  /var/www/html/a #挂载镜像到a目录
cd /etc/yum.repos.d/ #切换到yum文件所在目录
vi rocky-devel.repo  #编辑yum文件，修改红框处
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710914769705-43f3f0b0-8af3-4259-bba0-ddff77cb1129.png#averageHue=%231a1a1a&clientId=u4a6ad3ae-a8dd-4&from=paste&height=471&id=Id96p&originHeight=565&originWidth=1406&originalType=binary&ratio=1.2000000476837158&rotation=0&showTitle=false&size=75535&status=done&style=none&taskId=udc8faac3-9e18-499f-8329-321b080425a&title=&width=1171.6666201088183)
rm -rf 文件名 #删除除rocky-devel.repo外的所有文件
yum clean all #清除缓存
yum makecache #建立新的仓库缓存
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710914261520-3b9ddbf1-3a04-42ea-b089-9fe91d353d3b.png#averageHue=%231f1f1f&clientId=u0b7ec4b4-8459-4&from=paste&height=93&id=yVMmN&originHeight=112&originWidth=1613&originalType=binary&ratio=1.3499999046325684&rotation=0&showTitle=false&size=24133&status=done&style=none&taskId=u9e351881-b844-4950-b0a7-7eaa14b2065&title=&width=1344.1666132542844)
3.3 安装软件yum install qemu* virt-*  libvirt* bash-comp* httpd -y 
bash #使tab功能生效
包说明qemu-kvm：qemu模拟器
qemu-img：qemu磁盘image管理器
virt-install：用来创建虚拟机的命令行工具
libvirt：提供libvirtd daemon来管理虚拟机和控制hypervisor
libvirt-client：提供客户端API用来访问server和提供管理虚拟机命令行工具的virsh实体
virt-viewer：图形控制台，vnc的显示就是它提供
bash-completion：tab功能的软件包，可以进行命令补齐，减少配置难度
httpd：为搭建yum源提供共享服务
3.4 启动守护进程systemctl enable libvirtd  --now #设为开机自启并现在启动
systemctl status libvirtd              #查看运行状态
## 4小题
### 4.1 小题
准备工作1、关闭防火墙
systemctl disable firewalld --now #开机不自启并现在关闭防火墙

2、开启ssh服务
vi /etc/ssh/sshd_config #允许ssh
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710913557263-a70e1584-0c5f-4064-bd18-7667becc1e4f.png#averageHue=%230d0c0c&clientId=u5933070e-09df-4&from=paste&height=474&id=u192d1e12&originHeight=640&originWidth=1147&originalType=binary&ratio=1.2000000476837158&rotation=0&showTitle=false&size=56044&status=done&style=none&taskId=u865901bb-1116-482a-aea5-8203ee7302e&title=&width=849.6296896496307)
systemctl restart sshd #重启ssh服务
4.1 ssh登录Server2ssh root@10.4.220.100  #输入用户名密码
4.2 创建Linux0virt-install --name linux0 --memory 4096 --disk path=/var/lib/libvirt/images/linux0.qcow2,size=40,bus=virtio --vcpus 2 --os-variant auto --network bridge=br0,model=virtio --cdrom /opt/Rocky-9.2-x86_64-dvd.iso --graphics vnc,listen=0.0.0.0 --video virtio
字段释义：1、--name linux1 #设置虚拟机名称
2、--ram 2048  #分配内存大小，单位MB
3、--disk path=/var/lib/libvirt/images/linux1.qcow2,size=40,bus=virtio #指定硬盘文件路径 容量大小 类型 默认存放位置：/var/lib/libvirt/images
4、--vcpus 2 #设置虚拟CPU数
5、--os-variant rocky9 #指定操作系统类型
6、--network bridge=br0,model=virtio #网络模式 指定桥接网卡 类型
7、--location /opt/Rocky-9.1-x86_64-dvd.iso #选择安装镜像的本地路径
8、--graphics vnc,listen=0.0.0.0 #图形化输出为vnc，监听的IP地址为所有
9、--video virtio #指定显示驱动
4.3 VNC连接完成安装![image.png](https://cdn.nlark.com/yuque/0/2023/png/33622884/1683508867867-70583cd8-eccf-4513-8fab-fc496eae2dc3.png#averageHue=%23ebebea&clientId=u1beb751e-0f7c-4&from=paste&height=636&id=kOaH9&originHeight=636&originWidth=810&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48935&status=done&style=none&taskId=u646cde1c-6fd1-421e-8c95-13b3f58cf19&title=&width=810)
系统安装时用户名和密码自行设置，这里不做说明
注：关于VNC服务vnc默认端口为5900，如果有3台虚拟机，服务器IP为10.1.220.100:5900，那么登录vnc时，第一台为10.1.220.100，第二台为10.1.220.100:5901，第三台为10.1.220.100:5902，以此类推，防火墙处除了可以放行服务名，也可以放行相应端口
4.4 进行Linux的基础配置
- 修改IP地址

- 关闭防火墙

systemctl restart firewalld --now

- 允许ssh

vi /etc/ssh/sshd_conf
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710913557263-a70e1584-0c5f-4064-bd18-7667becc1e4f.png#averageHue=%230d0c0c&clientId=u5933070e-09df-4&from=paste&height=474&id=JWH4s&originHeight=640&originWidth=1147&originalType=binary&ratio=1.2000000476837158&rotation=0&showTitle=false&size=56044&status=done&style=none&taskId=u865901bb-1116-482a-aea5-8203ee7302e&title=&width=849.6296896496307)
systemctl restart sshd

- 配置局域网yum源

cd /etc/yum.repos.d/ #切换到yum文件所在目录
vi rocky-devel.repo  #编辑yum文件，修改红框处
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710914091631-9a030fc9-19b9-4345-8a0f-87f3d9553376.png#averageHue=%23181818&clientId=u0b7ec4b4-8459-4&from=paste&height=583&id=awsk9&originHeight=700&originWidth=1380&originalType=binary&ratio=1.3499999046325684&rotation=0&showTitle=false&size=87902&status=done&style=none&taskId=u71cce64a-097f-44d6-85d1-5b2d86a8100&title=&width=1149.9999543031074)
rm -rf 文件名 #删除除rocky-devel.repo外的所有文件
yum clean all #清除缓存
yum makecache #建立新的仓库缓存
![image.png](https://cdn.nlark.com/yuque/0/2024/png/33622884/1710914261520-3b9ddbf1-3a04-42ea-b089-9fe91d353d3b.png#averageHue=%231f1f1f&clientId=u0b7ec4b4-8459-4&from=paste&height=93&id=oiDW9&originHeight=112&originWidth=1613&originalType=binary&ratio=1.3499999046325684&rotation=0&showTitle=false&size=24133&status=done&style=none&taskId=u9e351881-b844-4950-b0a7-7eaa14b2065&title=&width=1344.1666132542844)

- 安装tab包和vim编辑器

yum install bash-comp* vim -y
### 4.2小题
创建快照
virsh shutdown linux1 #关机虚拟机
virsh snapshot-create-as linux0 linux-snapshot #创建快照

克隆
virt-clone --original linux0  --name linux1 --file /var/lib/libvirt/images/linux1.qcow2 --auto-clone
按上面的命令，照葫芦画瓢完成2-9的克隆

完善Linux1-9基础配置

1. 修改主机名

nmcli g hostname xxxx   
bash #使其主机名生效

2. 修改IP地址

vi /etc/Net

3. tab功能生效

bash

:::info
## ----扩展命令
1、列出所有虚拟机，虚拟机状态
virsh list --all  

2、启动虚拟机
virsh start linux1

3、关闭虚拟机
virsh shutdown linux1

4、重启虚拟机
virsh reboot linux1

5、销毁虚拟机，相当拔掉虚拟机的电源
virsh destroy linux1 

6、删除虚拟机
virsh undefine linux1

7、修改虚拟机名称
virsh domrename linux100 linux1

8、修改硬盘文件名称
mv /var/lib/libvirt/images/linux100.qcow2  /var/lib/libvirt/images/linux1.qcow2

9、获取域的网络接口状态
virsh domiflist linux1

10、恢复快照
virsh snapshot-revert linux1 linux-snapshot

11、删除快照
virsh snapshot-delete linux1 linux-snapshot

12、添加磁盘
qemu-img create -f qcow2 /cp/a.qcow2 10G

13、查看磁盘信息
qemu-img info /opt/a.qcow2

14、挂载磁盘
virsh attach-disk linux1 /cp/a.qcow2 vdb --persistent --subdriver=qcow2 
#将该磁盘连接到linux1当中，在linux中显示为vdb，persistent为永久的意思，subdriver指定磁盘类型

15、查看主机磁盘连接情况
virsh domblklist linux1

fdisk -l 查看所有磁盘信息，这个时候就有一个vdb

16、分离磁盘
virsh detach-disk linux1 /cp/a.qcow2
:::


